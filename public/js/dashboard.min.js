"use strict";var underscore=angular.module("underscore",[]);underscore.factory("_",function(){return window._}),angular.module("RDash",["ui.bootstrap","ui.router","ngCookies","satellizer","ngTable","angular-growl","ngAnimate","ui.select","ngSanitize","angular-loading-bar","angularMoment","underscore","angularModalService"]).constant("ENDPOINT_URI","http://piccoapi.local/").constant("moment",moment).filter("dateToISO",function(){return function(e){return e&&(e=new Date(Date.parse(e)),e=e.toISOString()),e}}).filter("titleCase",function(){return function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}}).filter("dateRange",function(){return function(e,t,r){return void 0===t&&void 0===r?e:e.filter(function(e){return void 0===e||void 0===e.start_date?!1:void 0!==t&&void 0===r?moment(e.start_date).isAfter(t):void 0===t&&void 0!==r?moment(e.end_date).isBefore(r):moment(e.start_date).isAfter(t)&&moment(e.end_date).isBefore(r)})}}).directive("permission",["AuthService",function(e){return{restrict:"A",scope:{permission:"="},link:function(t,r,o){t.$watch(e.isLoggedIn,function(){e.userHasPermission(t.permission)?r.show():r.hide()})}}}]).config(["growlProvider","$stateProvider","$urlRouterProvider","$authProvider","$httpProvider","$provide","ENDPOINT_URI",function(e,t,r,o,n,a,i){n.interceptors.push(["$q","$injector",function(e,t){return{responseError:function(r){console.log(r);var o=t.get("$state"),n=["token_not_provided","token_expired","token_absent","token_invalid"];return angular.forEach(n,function(e,t){r.data.error===e&&(localStorage.removeItem("user"),o.go("auth"))}),e.reject(r)}}}]),o.loginUrl=i+"/api/authenticate",e.globalTimeToLive(3600),e.globalDisableCountDown(!0),e.globalPosition("top-right")}]).run(["$rootScope","$state","$stateParams","AuthService",function(e,t,r,o){e.$state=t,e.$stateParams=r,e.$on("$stateChangeStart",function(r,n,a){e.toState=n,e.toStateParams=a;var i=JSON.parse(localStorage.getItem("user"));i&&(e.authenticated=!0,e.currentUser=i,"auth"===n.name&&(r.preventDefault(),t.go("index")),o.checkPermissionForView(n)||(r.preventDefault(),t.go("auth")))})}]);
"use strict";angular.module("RDash").config(["$stateProvider","$urlRouterProvider",function(t,e){e.otherwise("/status/range"),t.state("index",{url:"/status/range",templateUrl:"templates/statusAccountByRange.html",controller:"StatusByRangeController as acc"}).state("dashboard",{url:"/dashboard",templateUrl:"templates/ngDashboard.html",controller:"DashboardController as dash",data:{restrict:!0,roles:["admin","ceo","stakeholder"]}}).state("auth",{url:"/auth",templateUrl:"templates/loginView.html",controller:"AuthController as auth"}).state("projects",{url:"/projects",templateUrl:"templates/userView.html",controller:"UserController as user"}).state("obras",{url:"/obras/:projectId",templateUrl:"templates/projectListView.html",controller:"ProjectListController as prjList",resolve:{active:["$stateParams",function(t){return t.projectId}]}}).state("tables",{url:"/tables",templateUrl:"templates/tables.html"}).state("status",{url:"/status",templateUrl:"templates/statusAccount.html",controller:"StatusController as acc",data:{restrict:!0,roles:["admin","ceo"]}}).state("statusByRange",{url:"/status/range",templateUrl:"templates/statusAccountByRange.html",controller:"StatusByRangeController as acc"})}]);
function AlertsCtrl(e){e.alerts=[{type:"success",msg:"Thanks for visiting! Feel free to create pull requests to improve the dashboard!"},{type:"danger",msg:"Found a bug? Create an issue with as many details as you can."}],e.addAlert=function(){e.alerts.push({msg:"Another alert!"})},e.closeAlert=function(t){e.alerts.splice(t,1)}}angular.module("RDash").controller("AlertsCtrl",["$scope",AlertsCtrl]);
function MasterCtrl(t,o,e,g,n){var l=992;t.getWidth=function(){return window.innerWidth},t.logout=function(){g.logout().then(function(t){console.log(t),t.success?o.go("auth",{}):n.error(t.message,{ttl:5e3})},function(t){console.log(t)})},t.$watch(t.getWidth,function(o,g){o>=l?angular.isDefined(e.get("toggle"))?t.toggle=!!e.get("toggle"):t.toggle=!0:t.toggle=!1}),t.toggleSidebar=function(){t.toggle=!t.toggle,e.put("toggle",t.toggle)},window.onresize=function(){t.$apply()}}angular.module("RDash").controller("MasterCtrl",["$scope","$state","$cookieStore","AuthService","growl",MasterCtrl]);
function rdLoading(){var d={restrict:"AE",template:'<div class="loading"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>'};return d}angular.module("RDash").directive("rdLoading",rdLoading);
function rdWidgetBody(){var d={requires:"^rdWidget",scope:{loading:"@?",classes:"@?"},transclude:!0,template:'<div class="widget-body" ng-class="classes"><rd-loading ng-show="loading"></rd-loading><div ng-hide="loading" class="widget-content" ng-transclude></div></div>',restrict:"E"};return d}angular.module("RDash").directive("rdWidgetBody",rdWidgetBody);
function rdWidgetClick(){var i={transclude:!0,template:'<div class="widget widget-click" ng-transclude></div>',restrict:"EA"};return i}angular.module("RDash").directive("rdWidgetClick",rdWidgetClick);
function rdWidgetFooter(){var e={requires:"^rdWidget",transclude:!0,template:'<div class="widget-footer" ng-transclude></div>',restrict:"E"};return e}angular.module("RDash").directive("rdWidgetFooter",rdWidgetFooter);
function rdWidgetTitle(){var i={requires:"^rdWidget",scope:{title:"@",icon:"@"},transclude:!0,template:'<div class="widget-header"><div class="row"><div class="pull-left"><i class="fa" ng-class="icon"></i> {{title}} </div><div class="pull-right col-xs-6 col-sm-4" ng-transclude></div></div></div>',restrict:"E"};return i}angular.module("RDash").directive("rdWidgetHeader",rdWidgetTitle);
function rdWidget(){var d={transclude:!0,template:'<div class="widget" ng-transclude></div>',restrict:"EA"};return d}angular.module("RDash").directive("rdWidget",rdWidget);
!function(){"use strict";function e(e,r,n,t,a){function s(n){console.log("AuthService Login: ",n);return e.login(n).then(function(){return r.get(a+"api/authenticate/user")}).then(function(e){console.log(e);var r=JSON.stringify(e.data.user);return localStorage.setItem("user",r),t.authenticated=!0,t.currentUser=e.data.user,g(e,"Successful Login")},f("Invalid username and/or password."))}function u(){return e.logout().then(function(e){return localStorage.removeItem("user"),t.authenticated=!1,t.currentUser=null,g(e,"Successfully logged out")},f)}function o(){return null!=t.currentUser&&t.authenticated===!0}function i(e){return e.data&&e.data.restrict?c(e):!0}function c(e){if(!e.data||!e.data.roles)return!0;var r=e.data.roles||[];return l(r)}function l(e){if(!o())return!1;if(e.length<1)return!0;var r=!1;return angular.forEach(e,function(e,n){return t.currentUser.permissions.indexOf(e)>=0?void(r=!0):void 0}),r}function g(e,r){return angular.isDefined(e)&&angular.isDefined(r)?{success:!0,data:e.data,message:r}:{success:!0,message:r}}function f(e){if(angular.isDefined(e.data)&&angular.isDefined(e.data.message)){console.log("Error Object"),d=e.data.message;var r="Please correct the following errors: <br>";return angular.isObject(d)&&(angular.forEach(d,function(e,n){r+="<br>"+e}),d=r),{success:!1,message:d}}return console.log("Error Message"),d=e,function(){return{success:!1,message:d}}}var d="",h={};return h.Login=s,h.logout=u,h.isLoggedIn=o,h.checkPermissionForView=i,h.userHasPermissionForView=c,h.userHasPermission=l,h}angular.module("RDash").factory("AuthService",e),e.$inject=["$auth","$http","$state","$rootScope","ENDPOINT_URI"]}();
!function(){"use strict";function e(e){function n(){function n(){var n=e.flash;n&&(n.keepAfterLocationChange?n.keepAfterLocationChange=!1:delete e.flash)}e.$on("$locationChangeStart",function(){n()})}function t(n,t){e.flash={message:n,type:"success",keepAfterLocationChange:t}}function o(n,t){e.flash={message:n,type:"error",keepAfterLocationChange:t}}var a={};return a.Success=t,a.Error=o,n(),a}angular.module("RDash").factory("FlashService",e),e.$inject=["$rootScope"]}();
"use strict";function iModalService(o){function e(e,l,r,i,t,a){var c="templates/customModal.html",d="ModalController";return void 0!==t&&(c=t),void 0!==a&&(d=a),console.log("iModalService",r,"icontroller",d),o.showModal({templateUrl:c,controller:d,inputs:{title:e,body:l,data:r,sorting:i}})}var l={};return l.modalPromise=e,l}angular.module("RDash").factory("iModalService",iModalService),iModalService.$inject=["ModalService"];
"use strict";function ModalController(o,l,t,r,e){o.title=t,o.body=r,o.data=e,o.close=function(o){l(o,500)},o.myFilter=function(o){return null===o.id_proyecto?!0:void 0},o.filterNull=function(o){return null===o.id_proyecto?void 0:!0}}angular.module("RDash").controller("ModalController",ModalController),ModalController.$inject=["$scope","close","title","body","data"];
"use strict";function NgTableModalController(t,l,o,a,e,n,r){t.title=o,t.body=a,t.data=e,t.sorting=n,t.close=function(t){l(t,500)},t.myFilter=function(t){return null===t.id_proyecto?!0:void 0},t.filterNull=function(t){return null===t.id_proyecto?void 0:!0},t.tableParams=new r({page:1,count:10,sorting:t.sorting,filter:{account:""}},{counts:[],total:t.data.length,filterDelay:300,data:t.data})}angular.module("RDash").controller("NgTableModalController",NgTableModalController),NgTableModalController.$inject=["$scope","close","title","body","data","sorting","NgTableParams"];
function ProjectDetailController(e,r,o){var t=this;console.log(o),o.success?t.pt=o.data.data:e.error(o.message,{ttl:8e3})}angular.module("RDash").controller("ProjectDetailController",ProjectDetailController),ProjectDetailController.$inject=["growl","UsersService","project"];
function ProjectListController(n,o,e,t){function c(){u()}function a(){if(void 0!==e){i.active=e;var n=i.projects.map(function(n){return n.id}).indexOf(parseInt(e));i.openPrj(i.projects[n])}}function u(){n.getProjects().then(function(n){n.success?(i.projects=n.data.data,a()):o.error(n.message,{ttl:1e4})},function(n){console.log(n)})}function l(e){r(),n.getProjectIncome(e).then(function(n){if(n.success){i.projectIncome=n.data.data;var e=n.data.data,t=[],c=[],a=[];e.reduce(function(n,o){null==o.parent_id&&null==o.parent_account&&null==o.sub_account_name&&null==o.account&&null==o.account_name&&null==o.id_proyecto&&null==o.nombre?(console.log("top parent Summary",o),355==o.top_parent_id?i.totalIncome={top_account_name:o.top_account_name,balance:o.balance}:366==o.top_parent_id&&(i.totalOutcome={top_account_name:o.top_account_name,balance:o.balance})):355==o.top_parent_id?t.push({account:o.account_name,balance:o.balance}):366==o.top_parent_id&&null==o.account&&null==o.nombre&&c.push({account:o.sub_account_name,balance:o.balance})},{}),i.income=t,i.outcome=c,console.log("Total Income",JSON.stringify(i.totalIncome,null,2),"Total Outcome",JSON.stringify(i.totalOutcome,null,2)),a=e.filter(function(n){return 366==n.top_parent_id}).reduce(function(n,o){return n[o.sub_account_name]=n[o.sub_account_name]||[],n[o.sub_account_name].push({account:o.account,account_name:o.account_name,cargo:o.cargo,abono:o.abono,balance:o.balance}),n},{}),i.outcome_sub_details=a}else o.error(n.message,{ttl:9e3})},function(n){console.log(n)})}function r(){i.totalIncome=[],i.totalOutcome=[]}var i=this;i.projects=[],i.active,i.projectIncome=[],i.outcome_sub_details=[],i.totalIncome=[],i.totalOutcome=[],i.open2=function(){i.popup2.opened=!0},i.popup2={opened:!1},i.openEndDate=function(){i.ppEndDate.opened=!0},i.ppEndDate={opened:!1},i.getSubDetails=function(n){var o,e,c,a;e="Detalle de Cuenta "+n,a="templates/clickModal.html";var u=i.projectIncome.filter(function(o){return 366==o.top_parent_id&&o.sub_account_name==n}).reduce(function(n,o){return n[o.sub_account_name]=n[o.sub_account_name]||[],n[o.sub_account_name].push({account:o.account,account_name:o.account_name,cargo:o.cargo,abono:o.abono,balance:o.balance}),n},{});o=u[n],console.log("details function",u),console.log("details function",o),t.modalPromise(e,c,o,{account_name:"asc"},"templates/ngTableModal.html","NgTableModalController").then(function(n){n.element.modal()})},i.openPrj=function(n){console.log("current Project",n),i.isOpen(n)?i.openedPrj=void 0:(i.openedPrj=n,l(n.id))},i.isOpen=function(n){return i.openedPrj===n},i.anyItemOpen=function(){return void 0!==i.openedPrj},c()}angular.module("RDash").controller("ProjectListController",ProjectListController),ProjectListController.$inject=["ProjectsService","growl","active","iModalService"];
function ProjectsController(e,s){var o=this;o.listOfCustomers=null,o.selectedCustomer=null,s.getUsers().then(function(s){console.log(s),s.success?(o.listOfCustomers=s.data.data,o.selectedCustomer=o.listOfCustomers[0].id,o.loadOrders()):e.error(s.message,{ttl:1e4})},function(e){console.log(e)}),o.selectCustomer=function(e){o.selectedCustomer=e.id,o.loadOrders()},o.loadOrders=function(){o.listOfOrders=null,s.getUser(o.selectedCustomer).then(function(s){console.log(s),s.success?o.listOfOrders=s.data.data:e.error(s.message,{ttl:1e4})},function(e){console.log(e)})}}angular.module("RDash").controller("ProjectsController",ProjectsController),ProjectsController.$inject=["growl","ProjectsService"];
function ProjectsService(e,t,a,r){function n(a,r){return e.get(t+a).then(l,g("Error while getting "+r+" list."))}function o(e){var a=t+f;return e&&(a+="/"),a}function c(e,t){return n("projects/"+e,t)}function i(t){return e.get(o(!0)+"active/details").then(l,g)}function s(e,t){return n("projects/"+e+"/income",t)}function u(e){var t=864e5,a=[];return angular.forEach(e,function(e,r){var n={};n.top_parent_id=e.top_parent_id,n.id=e.id,n.name=e.name,n.full_name=e.full_name,n.start_date=e.start_date,n.end_date=e.end_date,n.income=e.income,n.outcome=e.outocme,n.balance=e.balance,n.budget=e.budget;var o=new Date(e.start_date),c=new Date(e.end_date),i=new Date,s=Date.UTC(o.getFullYear(),o.getMonth(),o.getDate()),u=Date.UTC(c.getFullYear(),c.getMonth(),c.getDate()),l=Date.UTC(i.getFullYear(),i.getMonth(),i.getDate());n.duration=Math.floor((u-s)/t),n.lapsed=Math.floor((l-s)/t),0==n.duration&&(n.duration=1),a.push(n)}),a}function l(e,t){return{success:!0,data:e.data,message:t}}function g(e){if(console.log(e),angular.isDefined(e.data)&&angular.isDefined(e.data.message)){j=e.data.message;var t="Please correct the following errors: <br>";return angular.isObject(j)&&(angular.forEach(j,function(e,a){t+="<br>"+e}),j=t),{success:!1,message:j}}return j=e,function(){return{success:!1,message:j}}}var d={},f="projects",j="";return d.getProject=a.partial(c,a,"Project Details"),d.getProjects=a.partial(n,"projects","Projects"),d.getActiveProjects=a.partial(n,"projects/active","Active Projects"),d.getProjectIncome=a.partial(s,a,"Project Income Details"),d.getActiveProjectsDetail=i,d.addDuration=u,d}angular.module("RDash").factory("ProjectsService",ProjectsService),ProjectsService.$inject=["$http","ENDPOINT_URI","_","moment"];
function UserController(e,s,t,a,n,r,o,c){function i(){d();var e=a.current.name;switch(e){case"projects":d();break;case"newUser":u();break;case"editUser":u(),editedUser.success?(f.setEditedUser(editedUser.data.data),CompanyService.getCompany(f.editedUser.company_id).then(function(e){e.success?(console.log(e.data.data),f.selected.value=e.data.data):c.error(e.message,{ttl:1e4})},function(e){console.log(e)})):(c.error(editedUser.message,{ttl:1e4}),a.go("users",{}))}}function l(){}function d(){n.getUsers().then(function(e){console.log(e),e.success?(f.users=e.data.data,f.tableParams=new r({page:1,count:6,filter:{first_name:"",last_name:"",email:""}},{filterDelay:0,data:e.data.data})):c.error(e.message,{ttl:1e4})},function(e){console.log(e)})}function u(){CompanyService.getCompanies().then(function(e){e.success?f.companiesArray=e.data.data:c.error(e.message,{ttl:1e4})},function(e){console.log(e)})}function m(e){if(angular.isDefined(f.selected)&&angular.isDefined(f.selected.value)){var s=f.selected.value.id;n.create(e,s).then(function(e){e.success?(c.success(e.message),a.go("users",{})):c.error(e.message,{ttl:1e4})},function(e){console.log(e)})}else c.error("Please select a Company to proceed.")}function g(){f.editedUser=null,f.isEditing=!1,n.clearEditedUser()}var f=this;f.users=[],f.applyGlobalSearch=l,f.newUser={user_name:"",first_name:"",last_name:"",gender:"",birth_date:"",height:"",email:"",password:"",commute:"",breakfast:"",hydration:"",hydration_amount:"",company_id:""},f.createUser=m,f.editedUser=null,f.editedUserId,f.isEditing=!1,f.companiesArray=[],f.selected=[],f.manageUsers=function(){a.go("manageUsers",{})},f.updateUser=function(e){if(angular.isDefined(f.selected)&&angular.isDefined(f.selected.value)){var s=e.company_id;e.company_id=f.selected.value.id,n.update(e.id,e,s).then(function(e){e.success?(c.success(e.message),g(),a.go("users",{})):c.error(e.message,{ttl:1e4})},function(e){console.log(e)})}else c.error("Please select a Company to proceed.")},f.deleteUser=function(e){iModalService.modalPromise("Delete User: "+e.first_name+" "+e.last_name,"Are you sure you want to delete this user?").then(function(s){s.element.modal(),s.close.then(function(s){s===!0&&n.deleteUser(e.id,e.company_id).then(function(e){e.success?(c.success(e.message),d()):c.error(e.message,{ttl:1e4})})})})},f.storeEditedUser=function(e){n.storeEditedUser(e)},f.setEditedUser=function(e){f.editedUser=angular.copy(e),f.isEditing=!0},f.logout=function(){$auth.logout().then(function(){localStorage.removeItem("user"),t.authenticated=!1,t.currentUser=null,a.go("auth",{})})},i()}angular.module("RDash").controller("UserController",UserController),UserController.$inject=["$scope","$http","$rootScope","$state","UsersService","NgTableParams","$timeout","growl"];
function AuthController(o,n,e){var l=this;l.login=function(){var r={user_name:l.email,password:l.password};console.log("Entering LoginController"),n.Login(r).then(function(n){console.log(n),n.success?o.go("index"):e.error(n.message,{ttl:5e3})},function(o){console.log(o)})}}angular.module("RDash").controller("AuthController",AuthController),AuthController.$inject=["$state","AuthService","growl"];
function DashboardController(e,t,o,a,n,r,i,c){function s(){l.getSummaries(),l.getProjects()}var l=this;l.companies=[],l.projects=[],l.projectsDuration=[],l.totalIncome=0,l.pendingIncome=0,l.totalOutcome=0,l.active=[],l.payables=0,l.receivables=0,l.payments=0,l.chart1={},l.incomeData=[{id:1,project_id:77,income_date:"2016-02-29",account:"400001",observations:"FACT 734 EXT 01 EXTRA",deposit:10867.49},{id:2,project_id:77,income_date:"2016-02-29",account:"400001",observations:"FACT 735 EST 02 EXTRA",deposit:127763.37},{id:3,project_id:77,income_date:"2015-12-11",account:"400001",observations:"FACT 713",deposit:281806.87},{id:4,project_id:77,income_date:"2015-12-11",account:"400001",observations:"FACT 712",deposit:257760.28},{id:5,project_id:77,income_date:"2015-11-21",account:"400001",observations:"EST 04 FACT 709",deposit:863544.94}],l.sum=function(e,t){return e.reduce(function(e,o){return e+(o[t]||0)},0)},l.sumFloat=function(e,t){return e.reduce(function(e,o){return parseFloat(e)+(parseFloat(o[t])||0)},0)},l.clickModal=function(e){var t,o,a,n,r,c;switch(e){case"projects":o="Obras Activas",t=l.projects,n="templates/ngTActiveProjectsModal.html",r="NgTableModalController",c={start_date:"desc",full_name:"asc"};break;case"income":o="Ingresos de Obras Activas",t=l.projects,n="templates/ngTActiveProjectsModal.html",r="NgTableModalController",c={income:"asc"}}i.modalPromise(o,a,t,c,n,r).then(function(e){e.element.modal()})},l.getSummaries=function(){o.all([c.getDebitsCredits(200,"0101","201601","201607"),c.getFinalBalance(200,"0101","201601","201607"),c.getFinalBalance(130,"0101","201601","201607")]).then(function(e){console.log("AuthService responses: ",e),l.payments=e[0].data[0].debit,l.payables=e[1],l.receivables=e[2]})},l.getProjects=function(){a.getActiveProjects().then(function(e){e.success?(l.projects=e.data,l.projectsDuration=l.loadProjectDuration(e.data),l.totalIncome=l.sumFloat(l.projects,"income"),console.log(l.totalIncome),l.pendingIncome=l.sumFloat(l.projects,"outcome"),l.totalOutcome=l.sumFloat(l.projects,"outcome"),l.initProjectsTable(l.projectsDuration)):r.error(e.message,{ttl:1e4})},function(e){console.log(e)})}.bind(l),l.loadProjectDuration=function(e){return a.addDuration(e)}.bind(l),l.initProjectsTable=function(e){var e=l.projectsDuration;l.columns=[{title:"Proyecto",field:"full_name",visible:!0,filter:{full_name:"text"}},{title:"Inicio",field:"start_date",visible:!0,filter:{start_date:"date"}},{title:"Fin",field:"end_date",visible:!0,filter:{end_date:"date"}},{title:"Progreso",field:"duration",visible:!0},{title:"Ingreso",field:"income",visible:!0}],l.projectTableParams=new n({page:1,count:5,filter:{name:"M"}},{counts:[],total:e.length,getData:function(o,a){var n=a.sorting()?t("orderBy")(e,a.orderBy()):e;o.resolve(n.slice((a.page()-1)*a.count(),a.page()*a.count()))}})},l.projectDetails=function(t){e.go("obras",{projectId:t})},s()}angular.module("RDash").controller("DashboardController",DashboardController),DashboardController.$inject=["$state","$filter","$q","ProjectsService","NgTableParams","growl","iModalService","AccountsService"];
function StatusByRangeController(t,n,a,e,c,u){function o(t){return u.reduce(t,function(t,n){return t+parseFloat(n)},0)}function s(){i()}function i(){(!p.accountTypes||p.accountTypes.length<1)&&a.getAccountTypes().then(function(n){n.success?p.accountTypes=n.data:t.error(n.message,{ttl:4e3})},function(t){console.log(t)})}function r(t,n){return t==n?0:n>t?-1:1}function l(t,n){return r(t.sub_tipo_cuenta,n.sub_tipo_cuenta)||r(t.parent_id,n.parent_id)}var p=this;p.statusAcc=[],p.parentAcc=[],p.statusStartDate,p.statusEndDate,p.startDateLabel,p.endDateLabel,p.statusType,p.statusTypes=["ERP","FNR","CONSOLIDADO"],p.businessUnit,p.businessUnits=[{Id:"01",Name:"Pico Total"},{Id:"0101",Name:"Construccion"},{Id:"0103",Name:"Servicios"}],p.accountTypes=[],p.getStatusByRange=function(){p.statusStartDate?Date.parse(p.statusStartDate)>Date.parse(p.statusEndDate)?t.error("La fecha de inicio debe ser mayor a la de fin.",{ttl:3500}):!p.statusEndDate&&p.isVisible?t.error("Por favor selecciona una fecha de fin.",{ttl:3500}):"CONSOLIDADO"===p.statusType?c.all([n.getAccountStatusByRange("ERP",p.businessUnit.Id,p.statusStartDate,p.statusEndDate),n.getAccountStatusByRange("FNR",p.businessUnit.Id,p.statusStartDate,p.statusEndDate)]).then(function(t){var n=t[0].data,a=t[1].data,c=n.concat(a),s=c.filter(function(t){return null!==t.account_id||"9999"===t.account}),i=s.filter(function(t){return(null===t.parent_id||null===t.top_parent_id)&&"9999"!==t.account}),r=u.chain(s).groupBy("account").map(function(t,n){return{tipo_cuenta:u.pluck(t,"tipo_cuenta")[0],sub_tipo_cuenta:u.pluck(t,"sub_tipo_cuenta")[0],top_parent_id:u.pluck(t,"top_parent_id")[0],parent_id:u.pluck(t,"parent_id")[0],account_id:u.pluck(t,"account_id")[0],account:n,description:u.pluck(t,"description")[0],cargo:o(u.pluck(t,"cargo")),abono:o(u.pluck(t,"abono")),balance:o(u.pluck(t,"balance"))}}).value();console.log("result",r);var d=u.chain(i).groupBy("sub_tipo_cuenta").map(function(t,n){return{tipo_cuenta:u.pluck(t,"tipo_cuenta")[0],sub_tipo_cuenta:n,top_parent_id:null,parent_id:999,account_id:null,account:null,description:u.pluck(t,"description")[0],cargo:o(u.pluck(t,"cargo")),abono:o(u.pluck(t,"abono")),balance:o(u.pluck(t,"balance"))}}).value();console.log("summaries",d),r=r.concat(d),p.statusAcc=r.filter(function(t){return null===t.parent_id||null===t.top_parent_id}),p.statusAcc.forEach(function(t){if("9999"===t.account&&(t.sub_tipo_cuenta=999),null===t.account_id){var n=u.find(p.accountTypes,function(n){return n.tipo_cuenta===t.tipo_cuenta&&n.sub_tipo_cuenta==t.sub_tipo_cuenta});console.log("Parent Accounts: ",t,"Subtipo cuenta: ",n),n&&(t.description="SUMA "+n.descripcion_subtipo)}null!==t.top_parent_id&&(t.childs=r.filter(function(n){return n.parent_id===t.account_id}))}),p.statusAcc=p.statusAcc.sort(l),p.statusAcc.forEach(function(t){null!==t.top_parent_id&&(t.folderClass="fa-plus",t.childs.forEach(function(t){t.folderClass="fa-plus",t.childs=r.filter(function(n){return n.parent_id===t.account_id})}))}),console.log("Nested Accounts",p.statusAcc);var f=e("date")(p.statusStartDate,"MMM yyyy");if(p.isVisible){var _=e("date")(p.statusEndDate,"MMM yyyy");p.startDateLabel="Fecha Incio: "+f,p.endDateLabel="Fecha Fin: "+_}else p.startDateLabel="Fecha: "+f})["catch"](function(t){})["finally"](function(){}):n.getAccountStatusByRange(p.statusType,p.businessUnit.Id,p.statusStartDate,p.statusEndDate).then(function(n){if(n.success){var a=n.data;p.statusAcc=a.filter(function(t){return null===t.parent_id||null===t.top_parent_id}),p.statusAcc.forEach(function(t){if("9999"===t.account&&(t.sub_tipo_cuenta=999),null===t.account_id){var a=u.find(p.accountTypes,function(n){return n.tipo_cuenta===t.tipo_cuenta&&n.sub_tipo_cuenta===t.sub_tipo_cuenta});console.log("Parent Accounts: ",t,"Subtipo cuenta: ",a),a&&(t.description="SUMA "+a.descripcion_subtipo,t.account=a.cuenta_final+1)}null!==t.top_parent_id&&(t.childs=n.data.filter(function(n){return n.parent_id===t.account_id}))}),p.statusAcc.forEach(function(t){null!==t.top_parent_id&&(t.folderClass="fa-plus",t.childs.forEach(function(t){t.folderClass="fa-plus",t.childs=n.data.filter(function(n){return n.parent_id===t.account_id})}))}),p.statusAcc=u.sortBy(p.statusAcc,"account"),console.log("Nested Accounts",p.statusAcc);var c=e("date")(p.statusStartDate,"MMM yyyy");if(p.isVisible){var o=e("date")(p.statusEndDate,"MMM yyyy");p.startDateLabel="Fecha Incio: "+c,p.endDateLabel="Fecha Fin: "+o}else p.startDateLabel="Fecha: "+c}else t.error(n.message,{ttl:4e3})},function(t){console.log(t)}):t.error("Por favor selecciona una fecha de inicio.",{ttl:3500})},p.toggleChildren=function(t){t.childrenVisible=!t.childrenVisible,t.folderClass=t.childrenVisible?"fa-minus":"fa-plus"},p.openStart=function(){p.popupStart.opened=!0},p.popupStart={opened:!1},p.openEnd=function(){p.popupEnd.opened=!0},p.popupEnd={opened:!1},p.isVisible=!0,p.ShowHide=function(){p.isVisible?(p.isVisible=!1,p.statusEndDate=""):p.isVisible=!0},s()}angular.module("RDash").controller("StatusByRangeController",StatusByRangeController),StatusByRangeController.$inject=["growl","StatusService","AccountsService","$filter","$q","_"];
function StatusController(t,n){function c(){e()}function e(){n.getAccountStatus().then(function(n){n.success?(o.statusAcc=n.data.filter(function(t){return null===t.parent_id}),o.statusAcc.forEach(function(t){t.childs=n.data.filter(function(n){return n.parent_id===t.account_id})}),o.statusAcc.forEach(function(t){t.folderClass="fa-plus",t.childs.forEach(function(t){t.folderClass="fa-plus",t.childs=n.data.filter(function(n){return n.parent_id===t.account_id})})}),console.log("Nested Accounts",o.statusAcc)):t.error(n.message,{ttl:1e4})},function(t){console.log(t)})}var o=this;o.statusAcc=[],o.parentAcc=[],o.statusStartDate,o.statusEndDate,o.toggleChildren=function(t){t.childrenVisible=!t.childrenVisible,t.folderClass=t.childrenVisible?"fa-minus":"fa-plus"},o.openStart=function(){o.popupStart.opened=!0},o.popupStart={opened:!1},c()}angular.module("RDash").controller("StatusController",StatusController),StatusController.$inject=["growl","StatusService"];
"use strict";function StatusService(e,t){function a(e){var a=t+o;return e&&(a+="/"),a}function n(){return e.get(a(!1)).then(s,u)}function r(t,n,r,c){r=r.getFullYear()+("0"+(r.getMonth()+1)).slice(-2);var o="";return c?(c=c.getFullYear()+("0"+(c.getMonth()+1)).slice(-2),o=a(!0)+t+"/"+n+"/"+r+"/"+c):o=a(!0)+t+"/"+n+"/"+r,console.log("URL: ",o),e.get(o).then(s,u)}function s(e,t){return{success:!0,data:e.data,message:t}}function u(e){if(console.log(e),angular.isDefined(e.data)&&angular.isDefined(e.data.message)){m=e.data.message;var t="Please correct the following errors: <br>";return angular.isObject(m)&&(angular.forEach(m,function(e,a){t+="<br>"+e}),m=t),{success:!1,message:m}}return m=e,function(){return{success:!1,message:m}}}var c={},o="accountStatus";return c.getAccountStatus=n,c.getAccountStatusByRange=r,c}angular.module("RDash").factory("StatusService",StatusService),StatusService.$inject=["$http","ENDPOINT_URI"];
"use strict";function AccountsService(e,t,n){function a(e){var n=t+d;return e&&(n+="/"),n}function r(e){var n=t+b;return e&&(n+="/"),n}function c(t){return e.get(r(!0)+t).then(l,g)}function i(){return e.get(a(!1)).then(l,g)}function u(t,n,a){return console.log("InitialBalance",r(!0)+t+"/bu/"+n+"/initialBalance/"+a),e.get(r(!0)+t+"/bu/"+n+"/initialBalance/"+a).then(l,g)}function s(t,n,a,c){return console.log("DebitsCredits",r(!0)+t+"/bu/"+n+"/debitsCredits/"+a+"/"+c),e.get(r(!0)+t+"/bu/"+n+"/debitsCredits/"+a+"/"+c).then(l,g)}function o(e,t,a,r){var i,o=n.defer();return n.all([c(e),u(e,t,a),s(e,t,a,r)]).then(function(e){var t=e[0].data,n=e[1].data,a=e[2].data,r=parseFloat(a[0].credit,10),c=parseFloat(a[0].debit,10);i=parseFloat(n[0].initial_balance,10),t[0].nature?i+=r-c:(console.log("account.nature",t.nature),i+=c-r),o.resolve(i)})["catch"](function(e){return console.log("getFinalBalance Error: ",e),o.reject(e)}),o.promise}function l(e,t){return{success:!0,data:e.data,message:t}}function g(e){if(console.log(e),angular.isDefined(e.data)&&angular.isDefined(e.data.message)){m=e.data.message;var t="Please correct the following errors: <br>";return angular.isObject(m)&&(angular.forEach(m,function(e,n){t+="<br>"+e}),m=t),{success:!1,message:m}}return m=e,function(){return{success:!1,message:m}}}var f={},d="accountTypes",b="accounts";return f.getAccount=c,f.getAccountTypes=i,f.getInitialBalance=u,f.getDebitsCredits=s,f.getFinalBalance=o,f}angular.module("RDash").factory("AccountsService",AccountsService),AccountsService.$inject=["$http","ENDPOINT_URI","$q"];